<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestro rinc√≥n especial ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'diario-amor-eri';

        window.db = db;
        window.auth = auth;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.appId = appId;
        
        // Regla 1: Rutas compartidas para persistencia global
        window.diaryCollection = collection(db, 'artifacts', appId, 'public', 'data', 'diario');
        window.favsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'favoritos');
        window.isAuthReady = false;

        const initAuth = async () => {
            // Regla 3: Auth antes de cualquier consulta
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error:", e);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.isAuthReady = true;
                window.currentUser = user;
                window.dispatchEvent(new CustomEvent('firebase-ready'));
            }
        });
    </script>

    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #fff5f5;
            overflow-x: hidden;
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }
        .romantic-font { font-family: 'Dancing Script', cursive; }
        
        button { border-radius: 9999px !important; white-space: nowrap; }
        .btn-style {
            @apply px-12 py-4 rounded-full font-bold shadow-xl transition-all duration-300 hover:scale-105 active:scale-95 text-sm md:text-lg inline-flex items-center justify-center;
            min-width: 150px;
        }

        .heart-word {
            position: absolute;
            color: #ff4d4d;
            font-weight: 600;
            opacity: 0;
            transform: scale(0.3);
            transition: opacity 2s ease-out, transform 1.5s ease-out;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes LuxuryGoldFade {
            0%, 100% { color: #ffd700; transform: translate(-50%, -50%) scale(1); filter: drop-shadow(0 0 5px #000); }
            50% { color: #ffffa0; transform: translate(-50%, -50%) scale(1.05); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4)); }
        }
        .eri-label-gold {
            animation: LuxuryGoldFade 7s ease-in-out infinite;
            font-weight: 900;
            -webkit-text-stroke: 1.8px #000000;
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            white-space: nowrap;
            text-align: center;
            opacity: 0;
            transition: opacity 3s ease-in;
        }

        .floating-bg-heart {
            position: absolute; color: #ff4d4d; pointer-events: none; z-index: 0;
            animation: floatUpEffect 12s linear forwards;
        }
        @keyframes floatUpEffect {
            0% { transform: translateY(110vh) rotate(0deg) scale(0.5); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-15vh) rotate(360deg) scale(1.4); opacity: 0; }
        }

        .fav-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2rem;
            width: 100%;
            max-width: 950px;
            margin: 0 auto;
            min-height: 550px;
        }
        
        .fav-sticker-slot {
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1200px;
        }

        .fav-sticker {
            padding: 24px;
            box-shadow: 6px 6px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 280px;
            aspect-ratio: 1/1;
            font-size: 0.8rem;
            color: #2d3748;
            transition: all 1.8s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            position: relative;
            background-color: #fff9c4;
            clip-path: polygon(2% 3%, 25% 1%, 50% 4%, 75% 1%, 98% 3%, 99% 30%, 97% 60%, 100% 90%, 98% 97%, 70% 99%, 40% 96%, 10% 98%, 2% 80%, 4% 40%);
        }

        .fav-sticker.entering { opacity: 0; transform: translateY(20px) scale(0.95); }
        .fav-sticker.active { opacity: 1; transform: translateY(0) scale(1); }
        .fav-sticker.leaving { opacity: 0; transform: translateY(-20px) scale(0.95); }

        .note-yellow { background-color: #fff9c4; }
        .note-pink { background-color: #fce4ec; }
        .note-blue { background-color: #e3f2fd; }
        .note-green { background-color: #f1f8e9; }
        .note-purple { background-color: #f3e5f5; }

        .flap-open { transform: rotateX(180deg); z-index: 5 !important; }
        .letter-pull { transform: translateY(-260px) !important; opacity: 1 !important; z-index: 50 !important; }

        .book-container { perspective: 2000px; width: 100%; max-width: 950px; height: 620px; display: flex; justify-content: center; margin-top: 20px; position: relative; }
        .book { width: 100%; height: 100%; display: flex; background: #f0e6d2; box-shadow: 0 25px 60px rgba(0,0,0,0.25); border-radius: 12px; position: relative; }
        .book-spine { width: 12px; background: rgba(0,0,0,0.18); height: 100%; position: absolute; left: 50%; transform: translateX(-50%); z-index: 20; box-shadow: inset 0 0 12px rgba(0,0,0,0.25); }
        .page { flex: 1; background: #fdfbf7; padding: 45px; position: relative; overflow: hidden; background-image: linear-gradient(#e5e5e5 1px, transparent 1px); background-size: 100% 30px; display: flex; flex-direction: column; z-index: 5; }
        
        .page-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            padding: 0 35px;
            text-align: center;
            font-size: 0.7rem;
            color: #718096;
            font-style: italic;
            font-weight: 500;
        }

        .diary-sticker-slot {
            position: absolute;
            font-size: 2.2rem;
            pointer-events: none;
            z-index: 10;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
            transition: all 0.6s ease;
            opacity: 0;
            transform: scale(0.5);
        }
        .diary-sticker-slot.active {
            opacity: 1;
            transform: scale(1);
        }

        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #db2777; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .centered-yes { position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; z-index: 30 !important; }

        @media (max-width: 768px) {
            .fav-grid { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr); gap: 1rem; }
            .book-container { height: auto; flex-direction: column; }
            .book { flex-direction: column; height: auto; }
            .page { min-height: 480px; padding: 30px; }
        }
    </style>
</head>
<body class="text-gray-800">

    <audio id="romantic-music" loop preload="auto">
        <source src="soundtrack.mp3" type="audio/mpeg">
    </audio>

    <div id="hearts-bg-container" class="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <nav id="top-nav" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-white/80 backdrop-blur-md p-2 rounded-full shadow-xl border border-pink-100 flex items-center">
        <div id="nav-content" class="flex gap-3 px-2">
            <button onclick="showSection('welcome')" class="btn-style text-pink-600 hover:bg-pink-50 min-w-[100px]">Inicio</button>
            <button onclick="resetValentine(); showSection('landing')" class="btn-style bg-pink-500 text-white min-w-[140px]">San Valent√≠n ‚ù§Ô∏è</button>
            <button onclick="showSection('diary')" class="btn-style bg-pink-100 text-pink-700 min-w-[100px]">Diario üìñ</button>
            <button onclick="showSection('magic')" class="btn-style bg-indigo-500 text-white min-w-[100px]">Magia ‚ú®</button>
        </div>
    </nav>

    <!-- BIENVENIDA -->
    <div id="section-welcome" class="min-h-screen flex flex-col items-center justify-center p-4 pt-24 text-center relative z-10">
        <div id="heart-word-cloud" class="relative w-[360px] h-[360px] md:w-[680px] md:h-[680px] mb-8 flex items-center justify-center">
            <h2 id="eri-label" class="romantic-font text-6xl md:text-9xl eri-label-gold opacity-0">Para mi Eri</h2>
        </div>
        <p class="romantic-font text-xl md:text-4xl text-pink-400 opacity-90 animate-pulse mt-10">Donde cada palabra cuenta nuestra historia...</p>
    </div>

    <!-- LANDING -->
    <div id="section-landing" class="hidden">
        <section class="min-h-screen flex flex-col items-center justify-center p-4 text-center relative z-10 pt-20">
            <div class="w-full max-w-3xl bg-white/95 backdrop-blur-sm p-10 rounded-3xl shadow-xl border border-pink-100">
                <h1 class="romantic-font text-5xl md:text-7xl text-pink-600 mb-6">Hola mi vida...</h1>
                <p class="text-lg md:text-2xl leading-relaxed mb-4">Solo quer√≠a decirte lo mucho que <span class="text-pink-600 font-bold">te amo</span>.</p>
                <p class="text-lg md:text-2xl leading-relaxed mb-4">Me la paso incre√≠ble cada d√≠a junto a ti. Me encanta cuando estamos <span class="text-pink-600 font-bold">cerquita</span>, pero tambi√©n cuando nos toca estar a la <span class="text-pink-600 font-bold">distancia</span> y nos quedamos hablando por mensajes o llamadas. Eres mi todo.</p>
                <div class="animate-bounce mt-14 text-pink-400 font-bold text-sm tracking-widest uppercase">Baja un poquito...</div>
            </div>
        </section>

        <section id="envelope-section" class="min-h-screen flex flex-col items-center justify-center p-4 relative z-10">
            <div class="envelope-container flex justify-center">
                <div class="envelope-wrapper" id="envelope-wrapper" style="width: 320px; height: 200px; position: relative; background: #ff8fa3; border-radius: 0 0 15px 15px; cursor: pointer;">
                    <div id="envelope-flap" class="flap" style="position: absolute; top: 0; width: 100%; height: 100%; background: #ff758f; clip-path: polygon(0 0, 100% 0, 50% 55%); z-index: 20; transform-origin: top; transition: 0.6s;"></div>
                    <div class="envelope-front-cover" style="position: absolute; width: 100%; height: 100%; z-index: 10; background: #ffb3c1; clip-path: polygon(0 0, 0 100%, 100% 100%, 100% 0, 50% 50%); border-radius: 0 0 15px 15px;"></div>
                    <div id="target-letter" class="absolute top-0 left-[5%] w-[90%] h-[95%] flex items-center justify-center bg-white z-[5] opacity-0 transition-all duration-700 rounded shadow-md pointer-events-none" style="font-weight: bold; color: #ff4d4d; text-align: center; padding: 15px; cursor: pointer;">¬°Rec√≥geme! ‚ù§Ô∏è</div>
                </div>
            </div>
            <p id="helper-text-envelope" class="mt-10 text-pink-400 font-medium animate-pulse">Toca el sobre para abrirlo</p>
        </section>
    </div>

    <!-- PREGUNTA VALENTINE -->
    <div id="section-question" class="hidden">
        <section class="min-h-screen flex flex-col items-center justify-center p-4 relative z-10">
            <div id="main-card" class="w-full max-w-4xl min-h-[500px] bg-white p-10 rounded-3xl shadow-2xl border-2 border-pink-200 flex flex-col items-center justify-center relative overflow-hidden text-center">
                <div id="content-asking">
                    <div class="text-6xl mb-10">üß∏üå∑‚ú®</div>
                    <h2 class="romantic-font text-4xl md:text-7xl text-pink-600 mb-14 px-4">¬øQuieres ser mi San Valent√≠n?</h2>
                    <div id="button-area" class="relative w-full h-48 flex items-center justify-center gap-12 md:gap-40">
                        <button id="btn-yes" class="btn-style bg-pink-500 text-white text-xl px-14 py-4 z-30">S√≠</button>
                        <button id="btn-no" class="btn-style bg-gray-200 text-gray-700 text-lg px-12 py-4 z-50">No</button>
                    </div>
                </div>
                <div id="content-success" class="hidden flex-col items-center">
                    <div class="text-8xl mb-10">ü•≥üíïü•∞</div>
                    <h2 id="success-title" class="romantic-font text-5xl md:text-8xl text-pink-600 mb-6 font-bold"></h2>
                    <p id="success-message" class="text-2xl md:text-4xl text-gray-700 italic px-4 whitespace-pre-line"></p>
                </div>
            </div>
        </section>
    </div>

    <!-- DIARIO -->
    <div id="section-diary" class="hidden min-h-screen pt-24 pb-32 flex flex-col items-center p-4">
        <h2 class="romantic-font text-5xl text-pink-600 mb-10">Nuestro Diario</h2>
        <div class="w-full max-w-lg bg-white p-8 rounded-3xl shadow-lg border-2 border-pink-100 mb-12">
            <div class="space-y-4">
                <input type="date" id="diary-date" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-pink-300">
                <textarea id="diary-text" rows="3" placeholder="¬øQu√© momento guardamos hoy?..." class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-pink-300 resize-none"></textarea>
                <button id="btn-save-diary" class="btn-style w-full bg-pink-500 text-white py-3 uppercase tracking-wide flex items-center justify-center gap-2">
                    Guardar <span id="diary-loader" class="loader hidden"></span>
                </button>
            </div>
        </div>
        <div class="book-container" id="diary-book-area">
            <div class="book" id="book-element">
                <div class="book-spine"></div>
                <div class="page page-left" id="diary-page-left">
                    <div class="diary-sticker-slot" style="top: 5%; left: 5%;" id="sticker-L1"></div>
                    <div class="diary-sticker-slot" style="top: 15%; right: 5%;" id="sticker-L2"></div>
                    <div class="diary-sticker-slot" style="bottom: 15%; left: 10%;" id="sticker-L3"></div>
                    <div class="diary-sticker-slot" style="bottom: 5%; right: 10%;" id="sticker-L4"></div>
                    <div id="diary-page-left-content" class="flex flex-col h-full text-center justify-center opacity-60">
                        <p id="page-date-left" class="romantic-font text-xl text-pink-300 mb-3"></p>
                        <div id="page-body-left" class="text-gray-400 text-xs italic line-clamp-6"></div>
                    </div>
                    <div class="page-footer" id="footer-left"></div>
                </div>
                <div class="page page-right" id="diary-page-right">
                    <div class="diary-sticker-slot" style="top: 8%; left: 12%;" id="sticker-R1"></div>
                    <div class="diary-sticker-slot" style="top: 5%; right: 10%;" id="sticker-R2"></div>
                    <div class="diary-sticker-slot" style="bottom: 10%; left: 5%;" id="sticker-R3"></div>
                    <div class="diary-sticker-slot" style="bottom: 15%; right: 5%;" id="sticker-R4"></div>
                    <div id="diary-page-right-content" class="flex flex-col h-full text-center justify-center">
                        <p id="page-date-right" class="romantic-font text-2xl text-pink-400 mb-4 border-b border-pink-100"></p>
                        <div id="page-body-right" class="text-gray-700 text-sm md:text-base italic font-medium px-6">Cargando nuestras p√°ginas...</div>
                    </div>
                    <div class="page-footer" id="footer-right"></div>
                </div>
            </div>
        </div>
        <div class="flex gap-8 items-center mt-8">
            <button id="prev-page" class="bg-white p-3 rounded-full shadow-md text-pink-500 disabled:opacity-30 border border-pink-100">‚óÄ</button>
            <span id="page-number" class="font-bold text-pink-400">1 / 1</span>
            <button id="next-page" class="bg-white p-3 rounded-full shadow-md text-pink-500 disabled:opacity-30 border border-pink-100">‚ñ∂</button>
        </div>
    </div>

    <!-- MAGIA -->
    <div id="section-magic" class="hidden min-h-screen flex flex-col items-center justify-center p-4 pt-24 pb-40 relative z-10">
        <div class="w-full max-w-5xl bg-white rounded-3xl p-8 md:p-12 shadow-2xl">
            <h3 class="romantic-font text-5xl text-pink-500 mb-14 text-center">Nuestra Zona M√°gica ‚ú®</h3>
            <div class="grid md:grid-cols-2 gap-8 mb-20">
                <div class="bg-pink-50 p-6 rounded-2xl flex flex-col items-center min-h-[250px] justify-between shadow-inner border border-pink-100">
                    <p class="text-gray-500 uppercase text-xs tracking-widest font-bold text-center">Dedicado a ti...</p>
                    <div class="flex gap-2 w-full">
                        <button id="btn-ai-msg" class="btn-style flex-grow bg-pink-400 text-white text-xs uppercase shadow-lg">Generar ‚ú®</button>
                        <button id="btn-fav-msg" class="hidden w-14 bg-yellow-400 text-white rounded-full text-xl flex items-center justify-center shadow-md">‚≠ê</button>
                    </div>
                    <p id="ai-msg-box" class="mt-4 text-pink-700 italic text-center hidden font-semibold text-sm px-2 transition-all duration-500"></p>
                </div>
                <div class="bg-indigo-50 p-6 rounded-2xl flex flex-col items-center min-h-[250px] justify-between shadow-inner border border-indigo-100">
                    <p class="text-gray-500 uppercase text-xs tracking-widest font-bold text-center">¬øQu√© hacemos hoy?</p>
                    <button id="btn-ai-date" class="btn-style w-full bg-indigo-400 text-white text-xs uppercase shadow-lg">Sugerir ‚ú®</button>
                    <p id="ai-date-box" class="mt-4 text-indigo-700 text-center hidden font-semibold text-sm px-2 transition-all duration-500"></p>
                </div>
            </div>
            <div class="border-t pt-12">
                <h4 class="romantic-font text-4xl text-pink-400 mb-10 text-center">Tus Favoritos ‚≠ê</h4>
                <div id="fav-collage" class="fav-grid">
                    <div class="fav-sticker-slot" id="slot-0"></div>
                    <div class="fav-sticker-slot" id="slot-1"></div>
                    <div class="fav-sticker-slot" id="slot-2"></div>
                    <div class="fav-sticker-slot" id="slot-3"></div>
                    <div class="fav-sticker-slot" id="slot-4"></div>
                    <div class="fav-sticker-slot" id="slot-5"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyDrwdtqd2vKXBrROIWQO49ZynmGTaYShD4";
        const audio = document.getElementById('romantic-music');
        let musicStarted = false;
        let lastGeneratedMsg = "";
        let entries = [];
        let favorites = [];
        let currentIndex = 0;
        let favRotationIndex = 0;
        const signatures = ["- Leandro", "- Leandro Guanoluisa", "- Isa√≠as", "- Isa√≠as Guanoluisa", "- IsaiahGuh", "- Issy", "- El amor de tu vida"];

        // 30 DEDICATORIAS LARGAS (BACKUP)
        const backupDedications = [
            "Desde que llegaste a mi vida, todo tiene un color diferente y m√°s brillante. Eres esa paz que siempre busqu√© y el apoyo incondicional que me hace sentir que puedo enfrentar cualquier tormenta si est√°s a mi lado. Gracias por elegirme cada d√≠a.",
            "Me encanta perderme en nuestra complicidad √∫nica, donde sobran las palabras porque nuestras miradas lo dicen todo. Eres mi refugio seguro, mi mejor amiga y el amor que siempre so√±√© tener conmigo para compartir cada peque√±o momento de la existencia.",
            "Tu sonrisa es, sin duda alguna, mi lugar favorito en el mundo entero y la raz√≥n por la que siempre busco ser una mejor persona. Aprecio infinitamente tu paciencia, tu ternura y esa forma tan hermosa en la que cuidas de lo nuestro con tanto respeto.",
            "Gracias por creer en nosotros incluso en esos momentos de duda, tu confianza es el motor que me impulsa a seguir adelante con alegr√≠a. No importa qu√© tan lejos estemos, mi coraz√≥n siempre te pertenece porque eres mi hogar y mi mayor orgullo.",
            "Eres mi calma en medio del caos de este mundo tan loco, la luz que gu√≠a mis pasos cuando el camino parece oscurecerse un poco. Valoro cada detalle tuyo, desde los grandes gestos hasta los besos robados que guardo como el tesoro m√°s preciado de mi alma.",
            "Estar a tu lado es el regalo m√°s grande y constante que la vida me ha dado, y prometo cuidarlo con toda la lealtad y el cari√±o que mereces. Me haces inmensamente feliz con tu sola presencia y con la seguridad de que caminamos juntos hacia un futuro lleno de sue√±os.",
            "Admiro profundamente tu fuerza interior y esa capacidad infinita que tienes para amar y comprender. Nuestra historia es mi libro preferido, uno que deseo escribir contigo eternamente, cap√≠tulo tras cap√≠tulo, llen√°ndolo de risas, apoyo mutuo y mucha sinceridad.",
            "Conf√≠o en ti con todo mi ser y me siento honrado de compartir mi vida con alguien tan especial, valiente e inteligente como t√∫. Eres mi equipo, mi compa√±era de aventuras y el alma que complementa la m√≠a de una forma que las palabras apenas alcanzan a describir.",
            "Aprecio cada una de nuestras charlas, esas que duran horas y nos hacen olvidar el tiempo, porque en ellas encuentro la esencia de lo que somos. Tu amor me hace sentir invencible y bendecido por tener a la mujer m√°s incre√≠ble del universo como mi pareja oficial.",
            "Simplemente gracias por existir y por ser t√∫, sin filtros y con toda esa magia que te caracteriza. El mundo es un lugar mucho mejor desde que t√∫ est√°s en √©l, repartiendo luz y d√°ndome motivos constantes para agradecerle al destino por habernos cruzado aquel d√≠a.",
            "Tu lealtad es un regalo que cuido celosamente en mi pecho, porque s√© que es la base de la inmensa confianza que nos une hoy. Eres mi mayor tesoro y la persona que me motiva a so√±ar en grande, sabiendo que siempre estar√°s ah√≠ para celebrar cada peque√±o triunfo conmigo.",
            "Haces que cada d√≠a valga la pena simplemente con un mensaje o una llamada, record√°ndome que no estoy solo en esta aventura llamada vida. Eres mi luz, mi gu√≠a y la raz√≥n por la que mi coraz√≥n late con tanta fuerza y alegr√≠a cada vez que pienso en nuestro futuro juntos.",
            "Te elijo hoy, ma√±ana y siempre, sin dudas ni miedos, porque eres la decisi√≥n m√°s f√°cil y hermosa que he tomado en toda mi existencia. Gracias por ser mi refugio, mi paz y la mujer que llena mis d√≠as de una esperanza infinita y un amor que no conoce fronteras.",
            "Amo la forma en que nos apoyamos mutuamente, creciendo de la mano y respetando cada paso que damos de forma individual y como pareja. Eres mi inspiraci√≥n diaria, la persona que me ense√±a a amar de forma pura, leal y con un respeto que es la envidia del mundo.",
            "Nuestra conexi√≥n va mucho m√°s all√° de lo f√≠sico, es una uni√≥n de almas que parece haber sido escrita en las estrellas hace mucho tiempo. Gracias por tu ternura, por tus mimos y por esa forma tan dulce en la que me haces sentir que soy el hombre m√°s afortunado del planeta.",
            "Valoro cada peque√±o detalle que haces por nosotros, desde las notas dulces hasta la forma en que me escuchas cuando m√°s lo necesito. Eres mi mejor amiga, mi confidente y el amor de mi vida, alguien a quien deseo proteger y amar con todas mis fuerzas por siempre.",
            "La paz que me transmites es invaluable en estos tiempos, eres mi puerto seguro en medio del mar picado y la brisa suave que refresca mi alma. Gracias por ser mi apoyo fundamental, por no soltar mi mano y por demostrarme que el amor verdadero s√≠ existe.",
            "Me haces mejor persona d√≠a tras d√≠a, y eso es algo que nunca podr√© terminar de agradecerte con palabras, solo con acciones y amor eterno. Eres mi sol, mi luna y todo mi universo, la mujer que cambi√≥ mi destino para llenarlo de flores, risas y una felicidad indescriptible.",
            "Cada beso tuyo es una promesa silenciosa que acepto con el alma abierta, sabiendo que estamos construyendo algo s√≥lido, real y muy duradero. Eres mi todo, absolutamente todo, y no hay lugar en el mundo donde prefiera estar que cerquita de ti, compartiendo la vida.",
            "Gracias por tu respeto y por la confianza inquebrantable que hemos forjado con sinceridad y mucho cari√±o a lo largo de este tiempo maravilloso. Eres mi estrella del norte, la gu√≠a que me mantiene en el camino correcto y la mujer que llena mi pecho de un orgullo inmenso.",
            "Adoro c√≥mo nos miramos y esa electricidad que a√∫n siento despu√©s de tanto tiempo, confirm√°ndome que lo nuestro es magia pura y verdadera pasi√≥n. Eres mi luz, mi paz y la compa√±era perfecta para recorrer cada rinc√≥n de este mundo, superando obst√°culos y riendo sin parar.",
            "Tu paciencia conmigo es algo que admiro y valoro cada segundo, demostr√°ndome que el amor tambi√©n es comprensi√≥n y apoyo en los momentos dif√≠ciles. Gracias por ser mi refugio, mi fuerza y la persona que me hace sonre√≠r incluso cuando no tengo ganas, eres sencillamente incre√≠ble.",
            "Eres mi equipo favorito, mi socia en los sue√±os y la persona con la que quiero construir un hogar lleno de amor, respeto y much√≠sima confianza mutua. Amo ver c√≥mo persigues tus metas con tanta valent√≠a, y prometo estar siempre en primera fila aplaudiendo cada uno de tus √©xitos.",
            "Nuestro amor es el tesoro m√°s grande que poseo, y lo cuidar√© con la lealtad de un caballero y la ternura de alguien que sabe que tiene oro en sus manos. Gracias por tu dulzura, por tus abrazos que curan todo y por ser esa esencia vital que me mantiene con una alegr√≠a constante.",
            "Estar contigo es aprender algo nuevo cada d√≠a sobre el amor, la entrega y la belleza de compartir la vida con alguien que realmente te valora y te respeta. Eres mi inspiraci√≥n, mi motivo de risa y la mujer que deseo que sea mi San Valent√≠n por el resto de mis d√≠as en esta tierra.",
            "No hay reto que parezca imposible si cuento con tu apoyo y tus palabras de aliento que me devuelven la fe cuando el mundo se pone un poco gris afuera. Eres mi sol personal, la luz que ilumina mi hogar interno y el amor m√°s leal que jam√°s haya tenido la fortuna de conocer y abrazar.",
            "Amo cada rinc√≥n de tu ser, tu inteligencia que me cautiva y esa forma tan hermosa que tienes de ver la vida con esperanza y bondad infinita en el coraz√≥n. Gracias por elegirme como tu compa√±ero, por darme tu confianza y por permitirme ser parte de tu mundo tan lleno de colores y magia.",
            "Eres mi estrella del norte en la inmensidad del cielo, la gu√≠a constante que me recuerda qui√©n soy y hacia d√≥nde vamos juntos en este viaje tan fascinante. Valoro tu lealtad, tu respeto y la forma en que cuidas de nuestra relaci√≥n con una dedicaci√≥n que me enamora m√°s y m√°s cada segundo.",
            "Simplemente gracias por ser mi paz en los d√≠as de tormenta y mi alegr√≠a en los d√≠as de sol, equilibrando mi vida con tu presencia tan tierna y poderosa a la vez. Te amo con un amor que crece sin l√≠mites, fortalecido por la confianza, el apoyo mutuo y esa complicidad que nos hace √∫nicos en el mundo.",
            "Eres, sin duda, la mejor parte de mi d√≠a y la raz√≥n principal por la que siempre despierto con una sonrisa llena de planes y sue√±os que quiero cumplir a tu lado. Gracias por tu cari√±o, por tu respeto y por ser esa mujer excepcional que tengo el honor de llamar mi compa√±era eterna y mi gran amor."
        ];

        // 30 CITAS DETALLADAS (BACKUP)
        const backupDates = [
            "Cocinemos juntos una pasta italiana desde cero, desde la masa hasta la salsa, mientras ponemos m√∫sica rom√°ntica de fondo y bailamos lento en la sala esperando a que la cena est√© lista.",
            "Preparemos un picnic nocturno en el suelo de la sala, con muchas mantas suaves, cojines c√≥modos y sandwiches gourmet para hablar de nuestros sue√±os m√°s profundos bajo la luz de guirnaldas y velas.",
            "Noche de spa casero totalmente relajante, con m√∫sica Zen, masajes con aceites arom√°ticos y mascarillas faciales para desconectar del estr√©s exterior y reconectar solo nosotros dos en paz.",
            "Marat√≥n de nuestras pel√≠culas favoritas de la infancia, preparando palomitas calientes con mucha mantequilla y qued√°ndonos acurrucados bajo una manta t√©rmica durante toda la noche de cine nost√°lgico.",
            "Sesi√≥n de arte compartido donde pintemos lienzos o tazas blancas el uno para el otro, usando mucha creatividad y colores para representar lo que m√°s amamos de nuestra relaci√≥n y nuestra historia juntos.",
            "Reto de cocina creativa utilizando √∫nicamente lo que encontremos en la nevera ahora mismo para inventar un plato totalmente nuevo y delicioso, el que pierda en sabor deber√° dar un masaje al ganador.",
            "Hagamos una c√°psula del tiempo personalizada donde escribamos cartas detalladas para leer en exactamente un a√±o, guardando tambi√©n peque√±os recuerdos de hoy en una cajita decorada por los dos.",
            "Picnic de observaci√≥n de estrellas desde la ventana o el balc√≥n, preparando un chocolate caliente espeso con malvaviscos y compartiendo planes emocionantes para nuestros futuros viajes y metas.",
            "Sesi√≥n de karaoke en YouTube cantando a todo pulm√≥n nuestros temas favoritos, sin importar si desafinamos o no, lo importante es la diversi√≥n absoluta y re√≠rnos juntos hasta que nos duela la barriga.",
            "Noche de videojuegos competitiva con muchos snacks crujientes y bebidas favoritas, estableciendo un sistema de puntos donde el gran ganador final elija el plan detallado para nuestra pr√≥xima gran cita.",
            "Degustaci√≥n de chocolates o quesos a ciegas, comprando diferentes variedades e intentando adivinar los ingredientes y puntuarlos en una libretita para descubrir cu√°les son nuestros nuevos favoritos comunes.",
            "Sesi√≥n de fotos divertida en casa, usando ropa diferente, accesorios locos y creando recuerdos visuales originales que capturen nuestra felicidad y esa complicidad que nos hace tan especiales como pareja.",
            "Construyamos un fuerte gigante usando todas las almohadas y s√°banas de la casa para meternos dentro a leer cuentos cortos o historias interesantes, disfrutando de la calidez de nuestro propio refugio.",
            "Noche de juegos de mesa cl√°sicos como cartas, domin√≥ o el que prefieran, apostando mimos, besos o promesas de peque√±as tareas del hogar para hacer la competencia mucho m√°s dulce y entretenida.",
            "Hagamos un postre complejo siguiendo un tutorial de reposter√≠a paso a paso, decor√°ndolo con muchas chispas y fresas para luego disfrutar juntos del dulce y delicioso resultado de nuestro trabajo en equipo.",
            "Planear con todo detalle el viaje de nuestros sue√±os, investigando hoteles hermosos, rutas tur√≠sticas, precios y mirando fotos del lugar ideal donde queremos estar juntos en las pr√≥ximas vacaciones.",
            "Noche de preguntas profundas para conocernos a√∫n m√°s, usando listas de internet que nos hagan reflexionar sobre la vida, el amor y nuestros sentimientos, fortaleciendo as√≠ nuestra conexi√≥n emocional.",
            "Aprender un baile totalmente nuevo siguiendo un tutorial por YouTube, intentando pasos de salsa, bachata o tango aunque tropecemos mil veces, riendo y disfrutando del ritmo y el contacto mutuo hoy.",
            "Spa de pies relajante con agua tibia, sales arom√°ticas y flores, d√°ndonos mimos mientras escuchamos una playlist de jazz suave que nos transporte a un estado de calma total dentro de nuestro hogar.",
            "Ver √°lbumes de fotos viejos o carpetas digitales de cuando √©ramos ni√±os y de nuestros primeros meses juntos, recordando an√©cdotas divertidas y d√°ndonos cuenta de cu√°nto hemos crecido y cambiado juntos.",
            "Hacer pizzas caseras personalizadas donde cada uno elija su mitad con los ingredientes m√°s locos y deliciosos, compitiendo por ver qui√©n crea la combinaci√≥n m√°s sabrosa antes de meterlas al horno.",
            "Sesi√≥n de yoga o meditaci√≥n guiada para parejas, conectando nuestras respiraciones y buscando la paz interior juntos en un ambiente decorado con incienso y luz tenue para una conexi√≥n de almas total.",
            "Noche de lectura compartida donde leamos un cap√≠tulo de un libro interesante o poemas rom√°nticos en voz alta el uno para el otro, disfrutando de la voz de nuestra pareja y de la historia elegida.",
            "Crear juntos una lista de reproducci√≥n en Spotify que defina perfectamente nuestra historia de amor, a√±adiendo canciones que nos recuerden momentos especiales para que podamos escucharla siempre que queramos.",
            "B√∫squeda del tesoro en casa, escondiendo notitas dulces y peque√±as sorpresas por diferentes habitaciones para que el otro tenga que hallarlas siguiendo pistas divertidas llenas de cari√±o y respeto.",
            "Hacer manualidades creativas con arcilla, plastilina o pinturas, intentando esculpir o modelar algo que represente nuestro amor o un s√≠mbolo que sea solo nuestro, disfrutando de la risa y el proceso creativo.",
            "Cena tem√°tica de alg√∫n pa√≠s que nos encante, decorando un poco la mesa acorde a esa cultura elegida y cocinando platos t√≠picos para viajar a trav√©s del paladar sin salir de nuestro rinc√≥n especial.",
            "Guerra de almohadas moderada seguida de una sesi√≥n de cosquillas y risas, dejando salir nuestra parte m√°s infantil y jovial para llenar la casa de alegr√≠a y de esa energ√≠a positiva que nos une.",
            "Escribir juntos una lista de 50 cosas que amamos profundamente del otro y le√©rnoslas frente a frente, tomados de las manos, para recordarnos por qu√© somos tan afortunados de habernos encontrado en la vida.",
            "Simplemente sentarnos a tomar un caf√© o t√© caliente sin celulares ni distracciones, solo para mirarnos a los ojos, estar presentes y disfrutar de la maravillosa compa√±√≠a del otro en total silencio y paz."
        ];

        async function callGemini(prompt, systemInstruction) {
            const salt = Math.random().toString(36).substring(7);
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { 
                contents: [{ parts: [{ text: `${prompt} (Semilla: ${salt})` }] }], 
                systemInstruction: { parts: [{ text: systemInstruction }] } 
            };

            try {
                const response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                if (response.ok) {
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/\*\*/g, '')?.trim();
                    if (text) return text;
                }
            } catch (e) { console.error("API Error:", e); }
            return null;
        }

        function showSection(id) {
            document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${id}`).classList.remove('hidden');
            window.scrollTo(0,0);
            if(id === 'welcome' && !heartFormed) startHeartAnimation();
        }

        async function playMusic() {
            if (musicStarted) return;
            try {
                audio.volume = 0;
                await audio.play();
                musicStarted = true;
                let vol = 0;
                const fadeIn = setInterval(() => {
                    if (vol < 0.4) { vol += 0.04; audio.volume = vol; }
                    else { clearInterval(fadeIn); }
                }, 250);
            } catch (e) {}
        }

        let heartFormed = false;
        function startHeartAnimation() {
            playMusic();
            heartFormed = true;
            const container = document.getElementById('heart-word-cloud');
            const wordsPool = ["Amor", "Vida", "Siempre", "Juntos", "Paz", "Luz", "Besos", "Sue√±os", "Magia", "Ternura", "Hogar", "Destino", "Alma", "√önica", "Mundo", "Cari√±o", "Fuego", "Cielo", "Zen", "Amour", "Love", "Amore", "Eterno", "M√≠a", "Sinceridad", "Fuerza", "Lealtad", "Fidelidad", "Respeto", "Pasi√≥n", "Refugio", "Abrigo", "Dulzura", "Tesoro", "Esencia", "Risa", "Aliento", "Confidente", "Gu√≠a", "Arte", "Vuelo", "Latido", "Calma", "Uni√≥n", "Poes√≠a", "Destino", "Aventura"];
            
            const occupied = [];
            const isOverlap = (x, y, w, h) => occupied.some(p => Math.abs(p.x - x) < (w + p.w)/1.8 && Math.abs(p.y - y) < (h + p.h)/1.8);

            let count = 0;
            const interval = setInterval(() => {
                if (count >= 200) { clearInterval(interval); document.getElementById('eri-label').style.opacity = "1"; return; }
                let attempts = 0;
                while(attempts < 300) {
                    const t = Math.random() * 2 * Math.PI;
                    const r = Math.pow(Math.random(), 0.6); 
                    const scale = (window.innerWidth < 768 ? 9 : 16) * r;
                    const x = 16 * Math.pow(Math.sin(t), 3) * scale;
                    const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * scale;
                    if (Math.abs(x) < 35 && Math.abs(y) < 25) { attempts++; continue; }
                    const word = wordsPool[count % wordsPool.length];
                    const fontSize = 9 + Math.random() * 9;
                    if(!isOverlap(x, y, word.length * 6, fontSize * 1.5)) {
                        const span = document.createElement('span');
                        span.className = 'heart-word'; span.innerText = word; span.style.fontSize = fontSize + 'px';
                        span.style.left = `calc(50% + ${x}px)`; span.style.top = `calc(50% + ${y}px)`;
                        container.appendChild(span);
                        occupied.push({x, y, w: word.length * 6, h: fontSize * 1.5});
                        setTimeout(() => { span.style.opacity = (0.35 + Math.random() * 0.4); span.style.transform = "scale(1)"; }, 100);
                        break;
                    }
                    attempts++;
                }
                count++;
            }, 60);
        }

        function createBGHeart() {
            const container = document.getElementById('hearts-bg-container');
            const h = document.createElement('div'); h.innerHTML = '‚ù§Ô∏è'; h.className = 'floating-bg-heart';
            h.style.left = Math.random() * 100 + 'vw'; h.style.fontSize = (Math.random() * 20 + 10) + 'px';
            container.appendChild(h);
            setTimeout(() => h.remove(), 12000);
        }
        setInterval(createBGHeart, 900);

        function renderCollage() {
            const slots = [0,1,2,3,4,5];
            const colors = ['note-yellow', 'note-pink', 'note-blue', 'note-green', 'note-purple', 'note-yellow'];
            slots.forEach((i, idx) => {
                const slotDiv = document.getElementById(`slot-${i}`);
                const oldNote = slotDiv.querySelector('.fav-sticker');
                let favIndex = favorites.length <= 6 ? i : (favRotationIndex + i) % favorites.length;
                const fav = favorites[favIndex];
                if (!fav) { if (oldNote) { oldNote.classList.add('leaving'); setTimeout(() => oldNote.remove(), 1200); } return; }
                if (oldNote && oldNote.dataset.id === fav.id) return;
                const note = document.createElement('div');
                note.dataset.id = fav.id; note.className = `fav-sticker ${colors[i % colors.length]} entering`;
                note.innerText = fav.source === 'ai' ? `"${fav.text}"` : `*${fav.text}*`;
                note.style.transform = `rotate(${Math.random() * 8 - 4}deg)`;
                if (oldNote) { oldNote.classList.add('leaving'); setTimeout(() => oldNote.remove(), 1200); }
                setTimeout(() => { slotDiv.appendChild(note); setTimeout(() => note.classList.add('active'), 100); }, idx * 300); 
            });
        }
        setInterval(() => { if (favorites.length > 6) { favRotationIndex = (favRotationIndex + 1) % favorites.length; renderCollage(); } }, 15000);

        const DIARY_EMOJIS = ["üß∏", "üå∑", "‚ú®", "üéÄ", "üêß", "üê±", "üê∂", "üßÅ", "üåà", "ü¶ã", "üå∏", "üåπ", "üç∞", "üéà"];
        function updateDiaryStickers(hasLeft, hasRight) {
            ["L1", "L2", "L3", "L4"].forEach(id => {
                const el = document.getElementById(`sticker-${id}`);
                if (hasLeft) { el.innerText = DIARY_EMOJIS[Math.floor(Math.random() * DIARY_EMOJIS.length)]; el.classList.add('active'); el.style.transform = `scale(1) rotate(${Math.random() * 40 - 20}deg)`; }
                else el.classList.remove('active');
            });
            ["R1", "R2", "R3", "R4"].forEach(id => {
                const el = document.getElementById(`sticker-${id}`);
                if (hasRight) { el.innerText = DIARY_EMOJIS[Math.floor(Math.random() * DIARY_EMOJIS.length)]; el.classList.add('active'); el.style.transform = `scale(1) rotate(${Math.random() * 40 - 20}deg)`; }
                else el.classList.remove('active');
            });
        }

        window.addEventListener('firebase-ready', () => {
            window.onSnapshot(window.diaryCollection, (snap) => {
                entries = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.date.toMillis() - a.date.toMillis());
                renderBook();
            }, (err) => console.error("Diary Error:", err));
            window.onSnapshot(window.favsCollection, (snap) => {
                favorites = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                renderCollage(); renderBook(); updateFavButtonState();
            }, (err) => console.error("Favs Error:", err));
        });

        function renderBook() {
            if (entries.length === 0) return;
            const current = entries[currentIndex];
            const prev = entries[currentIndex + 1];
            updateDiaryStickers(!!prev, !!current);
            document.getElementById('page-date-right').innerText = current.date.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('page-body-right').innerText = current.content;
            const leftContent = document.getElementById('diary-page-left-content');
            if(prev) {
                document.getElementById('page-date-left').innerText = prev.date.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                document.getElementById('page-body-left').innerText = prev.content;
                leftContent.parentElement.style.opacity = "1";
            } else leftContent.parentElement.style.opacity = "0";
            const footerL = document.getElementById('footer-left'), footerR = document.getElementById('footer-right');
            footerL.innerText = ""; footerR.innerText = "";
            if (favorites.length > 0) {
                const f1Idx = Math.floor(Math.random() * favorites.length);
                footerR.innerText = `"${favorites[f1Idx].text}" ${signatures[Math.floor(Math.random() * signatures.length)]}`;
                if (favorites.length > 1) footerL.innerText = `"${favorites[(f1Idx + 1) % favorites.length].text}" ${signatures[Math.floor(Math.random() * signatures.length)]}`;
            }
            document.getElementById('page-number').innerText = `${currentIndex + 1} / ${entries.length}`;
            document.getElementById('prev-page').disabled = currentIndex === entries.length - 1;
            document.getElementById('next-page').disabled = currentIndex === 0;
        }

        // --- SOBRE ---
        const envelope = document.getElementById('envelope-wrapper'), letter = document.getElementById('target-letter'), flap = document.getElementById('envelope-flap'), helperText = document.getElementById('helper-text-envelope');
        let envStep = 0;
        function resetValentine() {
            envStep = 0; flap.classList.remove('flap-open'); letter.classList.remove('letter-pull'); letter.style.opacity = '0'; letter.style.pointerEvents = 'none';
            helperText.innerText = "Toca el sobre para abrirlo"; document.getElementById('content-asking').classList.remove('hidden'); document.getElementById('content-success').classList.add('hidden');
            const btnYes = document.getElementById('btn-yes'), btnNo = document.getElementById('btn-no'); noCount = 0;
            btnYes.style.transform = "scale(1)"; btnYes.classList.remove('centered-yes'); btnNo.style.position = 'static'; btnYes.innerText = "S√≠"; btnNo.innerText = "No";
        }
        envelope.onclick = () => { if (envStep === 0) { flap.classList.add('flap-open'); envStep = 1; setTimeout(() => { letter.style.opacity = '1'; letter.style.pointerEvents = 'auto'; helperText.innerText = "Toca la carta para sacarla"; }, 600); } };
        letter.onclick = (e) => { e.stopPropagation(); if (envStep === 1) { letter.classList.add('letter-pull'); envStep = 2; setTimeout(() => showSection('question'), 1100); } };

        const btnNo = document.getElementById('btn-no'), btnYes = document.getElementById('btn-yes');
        let noCount = 0;
        btnNo.onmouseover = () => { if(noCount >= 3) { btnNo.style.position = 'absolute'; btnNo.style.left = Math.random() * 75 + '%'; btnNo.style.top = Math.random() * 75 + '%'; } };
        btnNo.onclick = () => {
            noCount++;
            const yesMsgs = ["s√≠, porfavor", "s√≠, si quiero", "s√≠, acepto", "s√≠, obvio", "s√≠, te amo", "s√≠, mil veces", "s√≠, claro", "s√≠, ya dale", "s√≠, por siempre", "s√≠, soy tuya"], noMsgs = ["no, no quiero", "no, te odio", "no, me caes mal", "no, ni lo sue√±es"];
            btnYes.innerText = yesMsgs[noCount % yesMsgs.length]; btnNo.innerText = noMsgs[noCount % noMsgs.length] || "No";
            const scale = Math.min(1 + noCount * 0.25, 2.5); btnYes.style.transform = btnYes.classList.contains('centered-yes') ? `translate(-50%, -50%) scale(${scale})` : `scale(${scale})`;
            if(noCount > 5) btnYes.classList.add('centered-yes');
            if(noCount >= 10) showSuccessUI("¬°Ya eres m√≠a!", "Te voy a obligar porque te amo demasiado para aceptar un no. üòç");
        };
        btnYes.onclick = () => { if (noCount === 0) showSuccessUI("¬°Siiii!", "Sab√≠a que aceptar√≠as a la primera. ¬°Me haces el m√°s feliz! ‚ù§Ô∏è"); else showSuccessUI("¬°Al fin!", "Te cost√≥ un poquito pero ya eres mi San Valent√≠n oficial. ¬°Te amo! ‚ù§Ô∏è"); };
        function showSuccessUI(title, msg) { document.getElementById('content-asking').classList.add('hidden'); document.getElementById('content-success').classList.remove('hidden'); document.getElementById('success-title').innerText = title; document.getElementById('success-message').innerText = msg; confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }

        // --- IA ACCIONES ---
        document.getElementById('btn-save-diary').onclick = async function() {
            const dateVal = document.getElementById('diary-date').value, textVal = document.getElementById('diary-text').value.trim();
            if (!dateVal || !textVal || !window.isAuthReady) return;
            this.disabled = true; document.getElementById('diary-loader').classList.remove('hidden');
            const res = await callGemini(textVal, "Asistente amoroso. Corrige ortograf√≠a y gram√°tica. Puedes a√±adir peque√±as frases dulces solo si mejoran la fluidez, pero NO cambies el sentido ni alargues mucho. M√°ximo 60 palabras.");
            try { await window.addDoc(window.diaryCollection, { content: res || textVal, date: window.Timestamp.fromDate(new Date(dateVal)), createdAt: window.Timestamp.now() }); document.getElementById('diary-text').value = ""; currentIndex = 0; } catch (e) {} finally { this.disabled = false; document.getElementById('diary-loader').classList.add('hidden'); }
        };

        let currentMsgIndex = -1;
        document.getElementById('btn-ai-msg').onclick = async function() {
            this.disabled = true; this.innerHTML = '<span class="loader"></span>';
            const res = await callGemini("Dedicaci√≥n amorosa extensa", "Escribe un mensaje de amor, apoyo, respeto o lealtad para mi pareja. No uses nombres. S√© muy creativo, tierno y expresivo. El mensaje debe ser extenso y profundo (60-80 palabras).");
            
            if(!res) {
                let nextIdx;
                do { nextIdx = Math.floor(Math.random() * backupDedications.length); } while (nextIdx === currentMsgIndex);
                currentMsgIndex = nextIdx;
                lastGeneratedMsg = backupDedications[currentMsgIndex];
            } else {
                lastGeneratedMsg = res;
            }
            
            document.getElementById('ai-msg-box').innerText = lastGeneratedMsg; document.getElementById('ai-msg-box').classList.remove('hidden');
            document.getElementById('btn-fav-msg').classList.remove('hidden'); updateFavButtonState(); this.disabled = false; this.innerHTML = 'Generar ‚ú®';
        };

        let currentDateIndex = -1;
        document.getElementById('btn-ai-date').onclick = async function() {
            this.disabled = true; this.innerHTML = '<span class="loader"></span>';
            const res = await callGemini("Cita en casa detallada", "Sugiere un plan rom√°ntico y detallado para dos en casa hoy. El plan debe ser variado y creativo (60-80 palabras). No repitas ideas anteriores.");
            
            if(!res) {
                let nextIdx;
                do { nextIdx = Math.floor(Math.random() * backupDates.length); } while (nextIdx === currentDateIndex);
                currentDateIndex = nextIdx;
                document.getElementById('ai-date-box').innerText = backupDates[currentDateIndex];
            } else {
                document.getElementById('ai-date-box').innerText = res;
            }
            
            document.getElementById('ai-date-box').classList.remove('hidden'); this.disabled = false; this.innerHTML = 'Sugerir ‚ú®';
        };

        document.getElementById('btn-fav-msg').onclick = async function() {
            if(!lastGeneratedMsg || !window.isAuthReady) return;
            const isFav = favorites.some(f => f.text === lastGeneratedMsg);
            if (isFav) { 
                const docId = favorites.find(f => f.text === lastGeneratedMsg).id; 
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'favoritos', docId)); 
            }
            else { 
                await window.addDoc(window.favsCollection, { 
                    text: lastGeneratedMsg, 
                    source: backupDedications.includes(lastGeneratedMsg) ? 'backup' : 'ai', 
                    createdAt: window.Timestamp.now() 
                }); 
            }
        };

        function updateFavButtonState() { document.getElementById('btn-fav-msg').innerText = favorites.some(f => f.text === lastGeneratedMsg) ? "‚ù§Ô∏è" : "‚≠ê"; }
        document.getElementById('prev-page').onclick = () => { if(currentIndex < entries.length - 1) { currentIndex++; renderBook(); } };
        document.getElementById('next-page').onclick = () => { if(currentIndex > 0) { currentIndex--; renderBook(); } };
        window.onload = () => showSection('welcome');
    </script>
</body>
</html>
