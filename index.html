<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Para mi personita favorita ‚ù§Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #fff5f5;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        .romantic-font {
            font-family: 'Dancing Script', cursive;
        }
        .heart {
            position: absolute;
            color: #ff4d4d;
            animation: float 6s linear infinite;
            opacity: 0;
            z-index: 0;
        }
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }
        
        .envelope-container {
            display: flex;
            justify-content: center;
            align-items: center;
            transform: scale(0.8);
        }
        @media (min-width: 640px) {
            .envelope-container { transform: scale(1); }
        }

        .envelope-wrapper {
            position: relative;
            width: 300px;
            height: 180px;
            background: #ff8fa3;
            border-radius: 0 0 15px 15px;
            cursor: pointer;
        }
        
        .envelope-front-cover {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
            background: #ffb3c1;
            clip-path: polygon(0 0, 0 100%, 100% 100%, 100% 0, 50% 50%);
            border-radius: 0 0 15px 15px;
        }

        .flap {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            background: #ff758f;
            clip-path: polygon(0 0, 100% 0, 50% 55%);
            z-index: 15;
            transform-origin: top;
            transition: transform 0.6s ease;
        }

        .letter {
            position: absolute;
            bottom: 5px;
            left: 10px;
            width: 280px;
            height: 140px;
            background: white;
            z-index: 3;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            font-weight: bold;
            color: #ff4d4d;
            padding: 15px;
            text-align: center;
            opacity: 0; 
        }

        .open-flap .flap {
            transform: rotateX(180deg);
            z-index: 2; 
        }
        .open-flap .letter {
            opacity: 1;
            transform: translateY(-40px);
        }
        .grabbed-letter .letter {
            transform: translateY(-160px);
            height: 200px;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .btn-transition {
            transition: all 0.2s ease-out;
        }

        .centered-yes {
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            margin: 0 !important;
            z-index: 30 !important; 
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #db2777;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- M√∫sica de fondo -->
    <audio id="romantic-music" loop preload="auto">
        <source src="soundtrack.mp3" type="audio/mpeg">
    </audio>

    <div id="hearts-container" class="fixed inset-0 pointer-events-none"></div>

    <!-- Secci√≥n 1: Introducci√≥n -->
    <section class="min-h-screen flex flex-col items-center justify-center p-4 text-center relative z-10">
        <div class="w-full max-w-3xl bg-white/95 backdrop-blur-sm p-6 md:p-10 rounded-3xl shadow-xl border border-pink-100">
            <h1 class="romantic-font text-4xl md:text-6xl text-pink-600 mb-4">Hola mi vida...</h1>
            <p class="text-base md:text-xl leading-relaxed mb-4">
                Solo quer√≠a decirte lo mucho que <span class="text-pink-600 font-bold">te amo</span>. 
            </p>
            <p class="text-base md:text-xl leading-relaxed mb-6">
                Me la paso incre√≠ble cada d√≠a junto a ti. Me encanta cuando estamos <span class="text-pink-600 font-bold">cerquita</span>, pero tambi√©n cuando nos toca estar a la <span class="text-pink-600 font-bold">distancia</span> y nos quedamos hablando por mensajes o llamadas. Eres mi todo.
            </p>
            <div class="animate-bounce">
                <p class="text-pink-400 font-bold mb-1 text-sm">Baja un poquito...</p>
                <svg class="w-5 h-5 mx-auto text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                </svg>
            </div>
        </div>
    </section>

    <!-- Secci√≥n 2: El Sobre -->
    <section id="envelope-section" class="min-h-screen flex flex-col items-center justify-center p-4 relative z-10">
        <h2 class="romantic-font text-3xl md:text-4xl text-pink-600 mb-8 text-center">Tengo algo para ti...</h2>
        <div class="envelope-container">
            <div class="envelope-wrapper" id="envelope-wrapper">
                <div class="flap"></div>
                <div class="envelope-front-cover"></div>
                <div id="target-letter" class="letter">
                    <div class="text-center">
                        <p id="letter-text" class="text-lg">¬°√Åbreme! ‚ù§Ô∏è</p>
                    </div>
                </div>
            </div>
        </div>
        <p id="helper-text" class="mt-6 text-pink-400 font-medium animate-pulse text-sm">Toca el sobre para abrirlo</p>
    </section>

    <!-- Secci√≥n 3: La Pregunta -->
    <section id="question-section" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center relative z-10 opacity-0 transition-opacity duration-1000">
        <div id="main-card" class="w-full max-w-4xl min-h-[450px] bg-white p-5 md:p-10 rounded-3xl shadow-2xl border-2 border-pink-200 flex flex-col items-center justify-center relative overflow-hidden">
            <div id="content-asking" class="w-full flex flex-col items-center h-full relative">
                <div class="text-5xl mb-4">üß∏üå∑‚ú®</div>
                <h2 class="romantic-font text-3xl md:text-5xl text-pink-600 mb-8 md:mb-12 px-2">¬øQuieres ser mi San Valent√≠n?</h2>
                
                <!-- Ajuste de separaci√≥n inicial -->
                <div id="button-area" class="relative w-full h-48 md:h-64 flex items-center justify-center gap-16 md:gap-24">
                    <button id="btn-yes" class="btn-transition bg-pink-500 text-white font-bold py-2 px-6 md:py-3 md:px-8 rounded-full shadow-lg text-lg md:text-xl z-30 whitespace-nowrap">S√≠</button>
                    <button id="btn-no" class="btn-transition bg-gray-200 text-gray-700 font-bold py-2 px-6 md:py-3 md:px-8 rounded-full shadow-md text-base md:text-lg z-50">No</button>
                </div>
            </div>
            <div id="content-success" class="hidden flex-col items-center justify-center text-center w-full">
                <div class="text-5xl md:text-7xl mb-4">ü•≥üíïü•∞</div>
                <h2 id="success-title" class="romantic-font text-4xl md:text-5xl text-pink-600 mb-4 font-bold">¬°Siiii!</h2>
                <p id="success-message" class="text-lg md:text-2xl text-gray-700 max-w-lg leading-relaxed mb-6 px-2"></p>
                <div class="animate-bounce">
                    <p class="text-pink-400 font-bold mb-1 text-sm">Baja un poquito...</p>
                    <svg class="w-5 h-5 mx-auto text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                    </svg>
                </div>
            </div>
        </div>
    </section>

    <!-- Secci√≥n 4: Zona M√°gica -->
    <section id="magic-zone-section" class="hidden min-h-screen flex flex-col items-center justify-center p-4 relative z-10 bg-white/30 backdrop-blur-sm">
        <div class="w-full max-w-2xl bg-white rounded-3xl p-6 md:p-10 shadow-2xl border-t-4 border-pink-400">
            <h3 class="romantic-font text-3xl md:text-4xl text-pink-500 mb-6 md:mb-8 text-center">Nuestra Zona M√°gica ‚ú®</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div class="bg-pink-50 p-4 rounded-2xl shadow-sm border border-pink-100 flex flex-col items-center">
                    <p class="text-gray-600 mb-3 font-medium text-xs md:text-sm text-center">Palabras para ti, amor de mi vida...</p>
                    <button id="btn-generate-dedication" class="w-full bg-pink-400 text-white py-2 rounded-xl font-bold transition-all text-xs md:text-sm shadow-md">Generar algo lindo ‚ú®</button>
                    <div id="ai-response-dedication" class="mt-4 text-pink-700 italic text-sm md:text-base text-center hidden leading-relaxed"></div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-2xl shadow-sm border border-indigo-100 flex flex-col items-center">
                    <p class="text-gray-600 mb-3 font-medium text-xs md:text-sm text-center">¬øQu√© hacemos hoy?</p>
                    <button id="btn-suggest-date" class="w-full bg-indigo-400 text-white py-2 rounded-xl font-bold transition-all text-xs md:text-sm shadow-md">Sugerir una cita ‚ú®</button>
                    <div id="ai-response-date" class="mt-4 text-indigo-700 text-sm md:text-base text-center hidden leading-relaxed"></div>
                </div>
            </div>
            <p class="text-center text-pink-300 mt-8 romantic-font text-lg md:text-xl">Hecho con amor para Eri ‚ù§Ô∏è</p>
        </div>
    </section>

    <script>
        const apiKey = "AIzaSyDrwdtqd2vKXBrROIWQO49ZynmGTaYShD4"; 
        const audio = document.getElementById('romantic-music');
        let musicStarted = false;
        
        // --- Mejorar Inicio de M√∫sica ---
        function playMusic() {
            if (musicStarted) return;
            musicStarted = true;
            audio.volume = 0;
            audio.play().then(() => {
                let vol = 0;
                const targetVol = 0.5; 
                const fadeIn = setInterval(() => {
                    if (vol < targetVol) {
                        vol += 0.02;
                        audio.volume = Math.min(vol, targetVol);
                    } else { clearInterval(fadeIn); }
                }, 100);
            }).catch(e => { musicStarted = false; });
        }

        // Detectores de interacci√≥n m√°s amplios para el sonido
        ['click', 'touchstart', 'scroll', 'keydown', 'mousemove'].forEach(evt => {
            window.addEventListener(evt, playMusic, { once: true });
        });

        // --- Gemini API corrigiendo respuestas separadas ---
        async function callGemini(prompt, type) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemInstructions = {
                dedication: "Eres el novio de Erika Ponce (le dices Eri). Escribe una dedicatoria rom√°ntica de m√°ximo 2 frases, muy tierno y casual. Sin negritas.",
                date: "Sugiere un plan de cita creativo y sencillo para hacer en casa con Erika (Eri). M√°ximo 2 frases. Sin negritas."
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstructions[type] }] }
            };

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Te amo mucho, Eri.";
                return rawText.replace(/\*\*/g, '');
            } catch (error) { return "Te amo much√≠simo. ‚ù§Ô∏è"; }
        }

        function createHeart() {
            const container = document.getElementById('hearts-container');
            const heart = document.createElement('div');
            heart.innerHTML = '‚ù§Ô∏è';
            heart.className = 'heart';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.fontSize = (Math.random() * 15 + 10) + 'px';
            heart.style.animationDuration = (Math.random() * 3 + 3) + 's';
            container.appendChild(heart);
            setTimeout(() => heart.remove(), 6000);
        }
        setInterval(createHeart, 400);

        const envelopeWrapper = document.getElementById('envelope-wrapper');
        const letterText = document.getElementById('letter-text');
        const helperText = document.getElementById('helper-text');
        const envelopeSection = document.getElementById('envelope-section');
        const questionSection = document.getElementById('question-section');
        const magicZoneSection = document.getElementById('magic-zone-section');

        let envelopeStep = 0; 
        envelopeWrapper.addEventListener('click', () => {
            playMusic();
            if (envelopeStep === 0) {
                envelopeWrapper.classList.add('open-flap');
                letterText.innerText = "¬°Ag√°rrame! ‚ù§Ô∏è";
                helperText.innerText = "Toca la carta";
                envelopeStep = 1;
            } else if (envelopeStep === 1) {
                envelopeWrapper.classList.add('grabbed-letter');
                envelopeStep = 2;
                setTimeout(() => {
                    envelopeSection.classList.add('fade-out');
                    setTimeout(() => {
                        envelopeSection.classList.add('hidden');
                        questionSection.classList.remove('hidden');
                        setTimeout(() => questionSection.classList.add('opacity-100'), 50);
                    }, 500);
                }, 1000);
            }
        });

        const btnNo = document.getElementById('btn-no');
        const btnYes = document.getElementById('btn-yes');
        const contentAsking = document.getElementById('content-asking');
        const contentSuccess = document.getElementById('content-success');
        const successTitle = document.getElementById('success-title');
        const successMessage = document.getElementById('success-message');
        const buttonArea = document.getElementById('button-area');

        let noCount = 0;
        let escapeInCurrentTurn = 0;
        const maxEscapesPerTurn = 4;

        const noMessages = ["no, no quiero", "no, te odio", "no, me caes mal", "no, ni lo sue√±es", "no, al√©jate", "no, busca a otra", "no, qu√© pesado", "no, me aburres", "no, vete ya", "no, imposible"];
        const yesMessages = ["s√≠, porfavor", "s√≠, si quiero", "s√≠, acepto", "s√≠, obvio", "s√≠, te amo", "s√≠, mil veces", "s√≠, claro", "s√≠, ya dale", "s√≠, por siempre", "s√≠, soy tuya"];

        // --- L√≥gica de Detecci√≥n PC/M√≥vil ---
        const isTouchDevice = () => ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        function checkOverlap() {
            const rectYes = btnYes.getBoundingClientRect();
            const rectNo = btnNo.getBoundingClientRect();
            return !(rectNo.right + 10 < rectYes.left || rectNo.left - 10 > rectYes.right || rectNo.bottom + 10 < rectYes.top || rectNo.top - 10 > rectYes.bottom);
        }

        function moveButton() {
            const areaRect = buttonArea.getBoundingClientRect();
            const noRect = btnNo.getBoundingClientRect();
            if (noCount >= 4) {
                btnYes.classList.add('centered-yes');
                btnNo.style.position = 'absolute';
                btnNo.style.zIndex = "100";
            }
            let foundPosition = false;
            let attempts = 0;
            while (!foundPosition && attempts < 40) {
                const newLeft = Math.random() * (areaRect.width - noRect.width);
                const newTop = Math.random() * (areaRect.height - noRect.height);
                btnNo.style.left = `${newLeft}px`;
                btnNo.style.top = `${newTop}px`;
                btnNo.style.margin = "0";
                if (!checkOverlap()) foundPosition = true;
                attempts++;
            }
        }

        // --- Manejo del Escape diferenciado ---
        function handleNoSelection(e) {
            if (noCount >= 4 && escapeInCurrentTurn < maxEscapesPerTurn) {
                if (e) e.preventDefault();
                moveButton(); 
                escapeInCurrentTurn++; 
                return true; 
            }
            return false; 
        }

        btnNo.addEventListener('click', (e) => {
            if (handleNoSelection(e)) return;

            noCount++;
            escapeInCurrentTurn = 0;
            if (noCount <= 10) {
                btnNo.innerText = noMessages[(noCount-1) % noMessages.length];
                btnYes.innerText = yesMessages[(noCount-1) % yesMessages.length];
                const factor = window.innerWidth < 768 ? 0.12 : 0.20;
                const yesScale = Math.min(1 + (noCount * factor), 1.8);
                if (noCount >= 4) { 
                    btnYes.style.transform = `translate(-50%, -50%) scale(${yesScale})`; 
                } else { 
                    btnYes.style.transform = `scale(${yesScale})`; 
                }
                btnNo.style.transform = `scale(${Math.max(0.7, 1 - noCount*0.04)})`;
                if (noCount >= 4) moveButton();
            } else { forceSuccess(); }
        });

        // Solo PC: Escapa al pasar el mouse
        btnNo.addEventListener('mouseover', () => {
            if (!isTouchDevice()) {
                handleNoSelection(null);
            }
        });

        // Celular: Escape al tocar
        btnNo.addEventListener('touchstart', (e) => {
            if (isTouchDevice()) {
                handleNoSelection(e);
            }
        }, {passive: false});

        function forceSuccess() {
            showSuccessUI("¬°Ya eres m√≠a!", "Te voy a obligar porque te amo demasiado para aceptar un no. üòç");
        }
        btnYes.addEventListener('click', () => {
            if (noCount === 0) { showSuccessUI("¬°Siiii!", "Sab√≠a que aceptar√≠as a la primera. ¬°Me haces el m√°s feliz! ‚ù§Ô∏è"); }
            else { showSuccessUI("¬°Al fin!", "Te cost√≥ un poquito pero ya eres mi San Valent√≠n oficial. ¬°Te amo! ‚ù§Ô∏è"); }
        });

        function showSuccessUI(title, msg) {
            contentAsking.classList.add('hidden');
            contentSuccess.classList.remove('hidden');
            contentSuccess.style.display = 'flex';
            successTitle.innerText = title;
            successMessage.innerText = msg;
            magicZoneSection.classList.remove('hidden');
            launchConfetti();
        }

        // --- Zona M√°gica: Funciones Separadas ---
        document.getElementById('btn-generate-dedication').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="loader"></span>';
            const res = await callGemini("Genera una dedicatoria de apoyo y amor para Erika Ponce.", "dedication");
            const box = document.getElementById('ai-response-dedication');
            box.innerText = res;
            box.classList.remove('hidden');
            this.disabled = false;
            this.innerHTML = 'Generar algo lindo ‚ú®';
        });

        document.getElementById('btn-suggest-date').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="loader"></span>';
            const res = await callGemini("Dime una idea de cita sencilla en casa para Eri.", "date");
            const box = document.getElementById('ai-response-date');
            box.innerText = res;
            box.classList.remove('hidden');
            this.disabled = false;
            this.innerHTML = 'Sugerir una cita ‚ú®';
        });

        function launchConfetti() {
            const defaults = { startVelocity: 35, spread: 360, ticks: 60, zIndex: 100 };
            const interval = setInterval(function() {
              confetti(Object.assign({}, defaults, { particleCount: 40, origin: { x: Math.random() * 0.4, y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount: 40, origin: { x: Math.random() * 0.4 + 0.6, y: Math.random() - 0.2 } }));
            }, 500);
            setTimeout(() => clearInterval(interval), 6000);
        }

        window.addEventListener('resize', () => {
            if (noCount >= 4) moveButton();
        });
    </script>
</body>
</html>
